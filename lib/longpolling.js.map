{"version":3,"sources":["../src/longpolling.js"],"names":["LongPolling","constructor","httpPack","scope","_pushStream","bind","start","stop","isDestroyed","_read","size","_addSocketListener","socket","on","generateBody","then","respondBody","undefined","length","push","handle","setTimeout","ctx","body","clearTimeout","removeListener"],"mappings":";;;;;;AAAA;;AAEe,MAAMA,WAAN,0BAAkC;AAC7CC,gBAAYC,QAAZ,EAAsBC,KAAtB,EAA4B;AACxB;AACA,aAAKD,QAAL,GAAgBA,QAAhB;AACA,aAAKC,KAAL,GAAaA,KAAb;AACA,aAAKC,WAAL,GAAmB,KAAKA,WAAL,CAAiBC,IAAjB,CAAsB,IAAtB,CAAnB;AACA,aAAKC,KAAL,GAAa,KAAKA,KAAL,CAAWD,IAAX,CAAgB,IAAhB,CAAb;AACA,aAAKE,IAAL,GAAY,KAAKA,IAAL,CAAUF,IAAV,CAAe,IAAf,CAAZ;AACA,aAAKG,WAAL,GAAmB,KAAnB;AACH;;AAEDC,UAAMC,IAAN,EAAW,CAEV;;AAEDC,uBAAmBC,MAAnB,EAA0B;AACtB,aAAKA,MAAL,GAAcA,MAAd;AACAA,eAAOC,EAAP,CAAU,OAAV,EAAmB,KAAKN,IAAxB;AACAK,eAAOC,EAAP,CAAU,OAAV,EAAmB,KAAKN,IAAxB;AACH;;AAEDH,kBAAa;AACT,aAAKF,QAAL,CAAcY,YAAd,CAA2B,KAAKX,KAAhC,EAAuCY,IAAvC,CAA4C,UAASC,WAAT,EAAqB;AAC7D,gBAAGA,eAAeC,SAAf,IAA4BD,YAAYE,MAAZ,GAAqB,CAApD,EAAsD;AAClD,qBAAKC,IAAL,CAAUH,WAAV;AACH;AACJ,SAJ2C,CAI1CX,IAJ0C,CAIrC,IAJqC,CAA5C,EAIcU,IAJd,CAImB,YAAU;AACzB,gBAAG,CAAC,KAAKP,WAAT,EAAqB;AACjB,qBAAKY,MAAL,GAAcC,WAAW,KAAKjB,WAAhB,EAA6B,GAA7B,CAAd;AACH;AACJ,SAJkB,CAIjBC,IAJiB,CAIZ,IAJY,CAJnB;AASH;;AAEDC,UAAMgB,GAAN,EAAU;AACN,YAAG,KAAKd,WAAR,EAAoB;AAChB;AACH;AACD,aAAKG,kBAAL,CAAwBW,IAAIV,MAA5B;AACAU,YAAIC,IAAJ,GAAW,IAAX;AACA,aAAKH,MAAL,GAAcC,WAAW,KAAKjB,WAAhB,EAA6B,GAA7B,CAAd;AACH;;AAEDG,WAAM;AACF,YAAG,KAAKC,WAAR,EAAoB;AAChB;AACH;AACD,aAAKA,WAAL,GAAmB,IAAnB;AACA,YAAG,KAAKY,MAAL,IAAeH,SAAlB,EAA4B;AACxBO,yBAAa,KAAKJ,MAAlB;AACH;AACD,YAAG,KAAKR,MAAL,IAAeK,SAAlB,EAA4B;AACxB,iBAAKL,MAAL,CAAYa,cAAZ,CAA2B,OAA3B,EAAoC,KAAKlB,IAAzC;AACA,iBAAKK,MAAL,CAAYa,cAAZ,CAA2B,OAA3B,EAAoC,KAAKlB,IAAzC;AACH;AACJ;AAtD4C;kBAA5BP,W","file":"longpolling.js","sourcesContent":["import {Readable} from 'stream';\n\nexport default class LongPolling extends Readable{\n    constructor(httpPack, scope){\n        super();\n        this.httpPack = httpPack;\n        this.scope = scope;\n        this._pushStream = this._pushStream.bind(this);\n        this.start = this.start.bind(this);\n        this.stop = this.stop.bind(this);\n        this.isDestroyed = false;\n    }\n\n    _read(size){\n\n    }\n\n    _addSocketListener(socket){\n        this.socket = socket;\n        socket.on('error', this.stop);\n        socket.on('close', this.stop);\n    }\n\n    _pushStream(){\n        this.httpPack.generateBody(this.scope).then(function(respondBody){\n            if(respondBody != undefined && respondBody.length > 0){\n                this.push(respondBody);\n            }\n        }.bind(this)).then(function(){\n            if(!this.isDestroyed){\n                this.handle = setTimeout(this._pushStream, 100);\n            }\n        }.bind(this));\n    }\n\n    start(ctx){\n        if(this.isDestroyed){\n            return;\n        }\n        this._addSocketListener(ctx.socket);\n        ctx.body = this;\n        this.handle = setTimeout(this._pushStream, 100);\n    }\n\n    stop(){\n        if(this.isDestroyed){\n            return;\n        }\n        this.isDestroyed = true;\n        if(this.handle != undefined){\n            clearTimeout(this.handle);\n        }\n        if(this.socket != undefined){\n            this.socket.removeListener('error', this.stop);\n            this.socket.removeListener('close', this.stop);\n        }\n    }\n}"]}