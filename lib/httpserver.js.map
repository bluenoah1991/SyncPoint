{"version":3,"sources":["../src/httpserver.js"],"names":["HttpServer","constructor","options","undefined","longPollings","httpPack","server","router","installRoute","syncCallback","use","buffer","routes","allowedMethods","listen","post","outgoingHandle","bind","incomingHandle","registerSyncCallback","cb","notifyNewNumberOfSegment","uid","number","notifyData","respondBody","JSON","stringify","scopes","scopesForUser","forEach","scope","commit","Buffer","longPollingsForUser","values","filter","lp","isDestroyed","map","authenticate","ctx","headers","length","index","indexOf","throw","username","substr","node","next","req","setTimeout","longPolling","stop","start","request","then","body","parseBody","payload","syncData","parse","syncId","clientNumberOfSegment","newPoints","respondSyncData","data"],"mappings":"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","file":"httpserver.js","sourcesContent":["import _ from 'lodash';\n\nimport Koa from 'koa';\nimport Router from 'koa-router';\nimport cors from 'kcors';\nimport body from 'koa-better-body';\nimport {HttpPack} from 'httppack-server';\n\nimport LongPolling from './longpolling';\n\nexport default class HttpServer{\n    constructor(options){\n        if(options == undefined){\n            options = {};\n        }\n        this.options = options;\n        this.longPollings = {};\n        this.httpPack = new HttpPack(options);\n        this.server = new Koa();\n        this.router = new Router();\n        this.installRoute();\n\n        this.syncCallback = function(){};\n\n        this.server\n            .use(cors())\n            .use(body({ buffer: true }))\n            .use(this.router.routes())\n            .use(this.router.allowedMethods());\n    }\n\n    listen(){\n        this.server.listen(this.options['httpport'] || 3000);\n    }\n\n    installRoute(){\n        this.router.post(this.options['outgoing_address'] || '/outgoing', this.outgoingHandle.bind(this));\n        this.router.post(this.options['incoming_address'] || '/incoming', this.incomingHandle.bind(this));\n    }\n\n    registerSyncCallback(cb){\n        this.syncCallback = cb;\n    }\n\n    notifyNewNumberOfSegment(uid, number){\n        let notifyData = {\n            \"newNumberOfSegment\": number\n        };\n        let respondBody = JSON.stringify(notifyData);\n        let scopes = this.scopesForUser(uid);\n        _.forEach(scopes, function(scope){\n            this.httpPack.commit(scope, new Buffer(respondBody, 'utf-8'), 0);\n        }.bind(this));\n    }\n\n    scopesForUser(uid){\n        let longPollingsForUser = this.longPollings[uid];\n        if(longPollingsForUser == undefined){\n            longPollingsForUser = {};\n            this.longPollings[uid] = longPollingsForUser;\n        }\n        let longPollings = _.values(longPollingsForUser);\n        longPollings = _.filter(longPollings, function(lp){\n            return !lp.isDestroyed;\n        });\n        let scopes = _.map(longPollings, function(lp){\n            return lp.scope;\n        });\n        return scopes;\n    }\n\n    authenticate(ctx){\n        let scope = ctx.headers['syncpoint-scope'];\n        if(scope == undefined || scope.length == 0){\n            return [scope, null, null];\n        }\n        let index = scope.indexOf(':');\n        if(index == -1){\n            ctx.throw(401);\n        }\n        let username = scope.substr(0, index);\n        let node = scope.substr(index + 1);\n        if(scope == undefined || scope.length == 0){\n            ctx.throw(401);\n        } else if(username == undefined || username.length == 0){\n            ctx.throw(401);\n        } else if(node == undefined || node.length == 0){\n            ctx.throw(401);\n        }\n        return [scope, username, node];\n    }\n\n    outgoingHandle(ctx, next){\n        let [scope, uid, node] = this.authenticate(ctx);\n\n        // disable timeout\n        ctx.req.setTimeout(0);\n\n        let longPollingsForUser = this.longPollings[uid];\n        if(longPollingsForUser == undefined){\n            longPollingsForUser = {};\n            this.longPollings[uid] = longPollingsForUser;\n        }\n        let longPolling = longPollingsForUser[node];\n        if(longPolling != undefined){\n            longPolling.stop();\n        }\n        longPolling = new LongPolling(this.httpPack, scope);\n        longPollingsForUser[node] = longPolling;\n        longPolling.start(ctx);\n        return next();\n    }\n\n    incomingHandle(ctx, next){\n        let [scope, uid, node] = this.authenticate(ctx);\n\n        return ctx.request.buffer().then(function(body){\n            return this.httpPack.parseBody(scope, body, function(scope, payload){\n                let syncData = JSON.parse(payload);\n                if(syncData != undefined){\n                    let syncId = syncData['id'];\n                    let clientNumberOfSegment = syncData['clientNumberOfSegment'];\n                    let newPoints = syncData['newPoints'];\n                    let respondSyncData = this.syncCallback(\n                        uid, syncId, clientNumberOfSegment, newPoints);\n                    respondSyncData.then(function(data){\n                        if(data != undefined){\n                            let respondBody = JSON.stringify(data);\n                            this.httpPack.commit(scope , new Buffer(respondBody, 'utf-8'), 2);\n                        }\n                    }.bind(this));\n                }\n            }.bind(this)).then(function(){\n                ctx.body = null;\n                return next();\n            }.bind(this));\n        }.bind(this));\n    }\n}"]}